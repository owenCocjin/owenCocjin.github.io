<html>
<head>
	<title>HTB: Devel</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="/CSS/blog.css">
	<link rel="stylesheet" href="/CSS/global.css">
</head>
<body class="noselect">
	<h1 id="title" class="blog_title">
		<a href="/index.html" class="homelink">
			HTB: Devel
		</a>
	</h1>
	<div id="big_wrapper" class="wordwrap">
		<div class="paragraph">
			<span id="menu_button" class="menu_item">...</span>
			<div id="menu">
				<a href="/index.html" class="menu_item">Home</a>
				<a href="/Blogs/TLDR/htb_devel.html" class="menu_item">TLDR</a>
				<a href="/Blogs/index.html" class="menu_item">All Blogs</a>
				<a href="/Blogs/resources.html" class="menu_item">Resources</a>
				<hr>
			</div>
		</div>

<div class="paragraph">
	<p class="subtitle">Intro:</p>
<p class="content">A nice, straightforward box that taught me more about using compilation tools than actually hacking the box!</p>
</div>
<div class="paragraph">
	<p class="subtitle">Recon:</p>
<p class="content">Pulling a classic <span class="code">nmap -sT -sV -A -v &lt;ip&gt;</span> Brings up an anon-enabled FTP server, and an open port 80.</p>
<p class="content">Doing a quick check on the web server version shown by nmap (Microsoft IIS httpd 7.5) shows it's up to date and probably not vulnerable to exploits itself. We can open the page itself which contains a single image of a welcome sign, which when clicked brings us to the homepage for IIS, Microsoft's web server.</p>
<p class="content">Checking out the FTP server shows us an interesting couple files: "iisstart.htm" and "welcome.png". The "welcome" picture hints to the website's homepage, and the .htm file confirms this. We currently have access to the webserver's root directory, which can be verified by uploading a text file and navigating to it in a browser: <span class="code">echo 'Hello, World!' &gt; hello.txt; ftp &lt;ip&gt; &lt;&lt;&lt; $(echo -e 'anonymous\n\nput hello.txt')</span>.</p>
</div>
<div class="paragraph">
	<p class="subtitle">NETting a shell:</p>
<p class="content">Since we are able to upload files, we can probably try uploading a reverse shell. But what language should our shell be written in? Well PHP doesn't work (because I've tested it), and by googling a bit because we aren't all web devs, we find we can run ASP code, as well as other languages such as C#. In an attempt to do everything as manually as possible, I see how hard it might be to write an ASP rshell manually. Nope. Next I try msfvenom to generate an rshell, but was unsuccessful in getting one to work. I would consistently get error 500 from the server, and to this day I'm not too sure why none of them worked.</p>
<div class="image imgzoom"><img src="./Pics/ftp.png"><p class="imgsub">The FTP root, cluttered by my tests and fails</p></div>
<p class="content">Finally, I caved and stole an aspx reverse shell off github <a href="#ref_1" class="link">[1]</a>. This worked like a charm though so I can't complain. Upload the shell via the FTP server and start a netcat listener: <span class="code">nc -lvp 3184</span>. <b>REMEMBER</b> to edit the address and port in the aspx file. Unfortunately the reverse shell doesn't land us the user flag, so we need to do a little bit more...</p>
</div>
<div class="paragraph">
	<p class="subtitle">Getting Usoot (User+Root):</p>
<p class="content">Looking around, we can don't see too much. We can move to "C:\Users" and find a user "babis" who's home directory we don't have access to. This means we either need to find credentials somewhere, or we can go straight to system. There are two reasons we're doing the latter:</p>
<p class="content"><ol class="content"><li>A quick look around shows nothing of interest; No databases, secret special folders that might hide credentials, nothing.</li><li>We hadn't come across anything hinting at the idea of stealing login details. This thought process is more geared towards the fact that this is a challenge and I'd advise against this because it'll build a bad habit of breaking the fourth wall O_o!</li></ol></p>
<p class="content">We can do a quick <span class="code">systeminfo</span> to see what we're working with. We find the OS version is "6.1.7600 N/A Build 7600". A google search of the version alone brings us an exploit against the "MS11-046" bulletin <a href="#ref_2" class="link">[2]</a>. It's a LPE, but the exploit is written in C (Boo hoo no Python!).</p>
<div class="image imgzoom"><img src="./Pics/systeminfo.png"><p class="imgsub">"systeminfo" showing us the OS name & version</p></div>
<p class="content">There is no compiler on the target which means we need to compile it on our machine, which is a Linux box. How can we compile a Windows binary on a Linux box? MinGW-w64 that's how! It took me a decent amount of research to find this but here we go. Install mingw however you do on your system. Then compile it using: <span class="code">i686-w64-mingw32-gcc &lt;exploit file&gt; -o exploit.exe -l ws2_32</span>. This is the command breakdown:</p>
<p class="content"><ul class="content"><li><span class="code">i686</span>: Means we're compiling for a 32-bit processor (duh).</li><li><span class="code">w64-mingw32</span>: The program name. The "w64" is just the latest mingw version (as opposed to "mingw"). This is consistent across all commands.</li><li><span class="code">gcc</span>: The compiler we're using to compile the code. Here we're compiling C code, hence "gcc". There are other tools, such as "objdump" or "strings". Try playing around with them!</li><li><span class="code">-o exploit.exe</span>: The output file.</li><li><span class="code">-l ws2_32</span>: Link the "ws2_32" library. The exploit itself tells us how to compile the file, but you can also determine which libraries are required by the "#pragma comment" line in the code.</li></ul></p>
<p class="content">Final step is to upload the compiled exe (I just used the FTP server because it's already there) and execute it: <span class="code">exploit.exe</span>. Now you won't see anything happen (it only prints when you exit the shell), but if you try "whoami" you'll see the beautiful "nt authority/system" popup on a new line. Go get those flags:</p>
<p class="content"><ul class="content"><li><span class="code">type c:\Users\babis\Desktop\user.txt.txt</span> (Yeah there's a typo in the actual flag, not the command.)</li><li><span class="code">type c:\Users\Administrator\Desktop\root.txt</span></li></ul></p>
<div class="image"><img src="./Pics/exploit.png"><p class="imgsub">Showing off the exploit, as well as the output after exiting the shell</p></div>
</div>
<div class="paragraph">
	<p class="subtitle">Understanding MS11-046:</p>
<p class="content">Just so we aren't blindly using exploit, let's try to understand this, at least slightly.</p>
<p class="content">This is an LPE exploit that abuses an issue in the Ancillary Function Driver "afd.sys". It's a kernel mode driver that is responsible for allowing proper functionality of the Winsock TCP/IP protocol <a href="#ref_3" class="link">[3]</a>. The exploit works because the driver doesn't properly validate input passed from user mode, meaning a specifically-crafted input will allow us to up our privileges.</p>
<p class="content">The way our exploit does this is by starting an arbitrary socket connection using Winsock, which will invoke "afd.sys".</p>
<div class="image imgzoom"><img src="./Pics/socket.png"><p class="imgsub">Connecting to closed socket</p></div>
<p class="content">Next it generates shellcode that will steal the AFD application's access token. The shellcode will then copy the token to our proces, effectively turning us into System.</p>
<div class="image imgzoom"><img src="./Pics/shellcode.png"><p class="imgsub">Creating the shellcode</p></div>
<p class="content">Finally, it sends the shellcode, upgrades us to System, then starts a shell as System <a href="#ref_4" class="link">[4]</a>.</p>
<div class="image imgzoom"><img src="./Pics/sendexploit.png"><p class="imgsub">Part of exploit execution. See <a href="#ref_4" class="link">[4]</a> for detailed explanation</p></div>
</div>
<br><br><br><div class="paragraph res_list">
	<p class="subtitle">Resources:</p>
<p class="content"><a id="ref_1" href="/Blogs/resources.html#rshell_aspx" class="menu_item">ASPX Reverse Shell</a></p><br>
<p class="content"><a id="ref_2" href="https://www.exploit-db.com/exploits/40564" class="menu_item" target="_blank">afd.sys Exploit</a>&nbsp<b>[EXTERNAL]</b></p><br>
<p class="content"><a id="ref_3" href="https://www.file.net/process/afd.sys.html" class="menu_item" target="_blank">AFD Description</a>&nbsp<b>[EXTERNAL]</b></p><br>
<p class="content"><a id="ref_4" href="http://poppopret.blogspot.com/2011/07/windows-kernel-exploitation-basics-part.html" class="menu_item" target="_blank">NtQueryIntervalProfile()</a>&nbsp<b>[EXTERNAL]</b></p><br>
</div>
		<br>
		<div class="paragraph">
			<hr>
			<p class="content">Last edit: 2021.08.25</p>
		</div>
	</div>
</body>
<footer>
	<script type="text/javascript" src="/JS/blog.js"></script>
	<script type="text/javascript" src="/JS/cookies.js"></script>
</footer>
</html>
